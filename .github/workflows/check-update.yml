name: Check PDFium Update

on:
  schedule:
    # 1st and 15th of each month at 08:00 UTC
    - cron: '0 8 1,15 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version matches'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Detect latest upstream release
      id: upstream
      run: |
        RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/bblanchon/pdfium-binaries/releases/latest)

        RELEASE_NAME=$(echo "$RELEASE_JSON" | jq -r '.name')
        RELEASE_ID=$(echo "$RELEASE_JSON" | jq -r '.id')
        TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')

        # Extract version from name like "PDFium v134.0.6996.0"
        UPSTREAM_VERSION=$(echo "$RELEASE_NAME" | grep -oP '\d+\.\d+\.\d+\.\d+')

        if [ -z "$UPSTREAM_VERSION" ]; then
          echo "::error::Could not parse upstream version from release name: $RELEASE_NAME"
          exit 1
        fi

        echo "version=$UPSTREAM_VERSION" >> "$GITHUB_OUTPUT"
        echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
        echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
        echo "Upstream version: $UPSTREAM_VERSION (release ID: $RELEASE_ID, tag: $TAG_NAME)"

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true

    - name: Read current version
      id: current
      run: |
        CURRENT_VERSION=$(grep -oP '(?<=<Version>).*(?=</Version>)' src/Directory.Build.props)
        echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
        echo "Current version: $CURRENT_VERSION"

    - name: Compare versions
      id: compare
      run: |
        UPSTREAM="${{ steps.upstream.outputs.version }}"
        CURRENT="${{ steps.current.outputs.version }}"
        FORCE="${{ github.event.inputs.force_update }}"

        if [ "$UPSTREAM" = "$CURRENT" ] && [ "$FORCE" != "true" ]; then
          echo "No update needed. Upstream ($UPSTREAM) matches current ($CURRENT)."
          echo "needs_update=false" >> "$GITHUB_OUTPUT"
        else
          echo "Update available: $CURRENT -> $UPSTREAM (force=$FORCE)"
          echo "needs_update=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Install .NET
      if: steps.compare.outputs.needs_update == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.*

    - name: Install native dependencies
      if: steps.compare.outputs.needs_update == 'true'
      run: sudo apt-get update && sudo apt-get install -y libc6-dev

    - name: Build bindings generator
      if: steps.compare.outputs.needs_update == 'true'
      run: dotnet build src/PDFiumCoreBindingsGenerator/PDFiumCoreBindingsGenerator.csproj -c Release

    - name: Generate bindings
      if: steps.compare.outputs.needs_update == 'true'
      run: |
        dotnet src/PDFiumCoreBindingsGenerator/bin/Release/net8.0/PDFiumCoreBindingsGenerator.dll \
          ${{ steps.upstream.outputs.release_id }} true 0

    - name: Build PDFiumCore
      if: steps.compare.outputs.needs_update == 'true'
      run: dotnet build src/PDFiumCore -c Release

    - name: Run tests
      if: steps.compare.outputs.needs_update == 'true'
      run: dotnet test src/PDFiumCore.Tests -c Release

    - name: Create pull request
      if: steps.compare.outputs.needs_update == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: update/pdfium-${{ steps.upstream.outputs.version }}
        title: "Update PDFium to v${{ steps.upstream.outputs.version }}"
        body: |
          ## Automated PDFium Update

          - **Upstream release:** ${{ steps.upstream.outputs.tag_name }}
          - **Version:** ${{ steps.upstream.outputs.version }}
          - **Release ID:** ${{ steps.upstream.outputs.release_id }}
          - **Source:** [bblanchon/pdfium-binaries](https://github.com/bblanchon/pdfium-binaries/releases/tag/${{ steps.upstream.outputs.tag_name }})

          Generated by the bi-weekly PDFium update check workflow.
        commit-message: "PDFium version v${{ steps.upstream.outputs.version }} ${{ steps.upstream.outputs.tag_name }} [master]"
        labels: automated-update
